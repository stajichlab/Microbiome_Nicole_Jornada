---
title: "Jornada_Q2_bacteria"
author: "Nat Pombubpa"
modified by: "Nicole Pietrasiak""
date: "updated on 2/25/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Jornada Qiime2 Bacteria
This is documentation and codes for Bacterial analysis in Jornada dataset.

Otu table, taxonomy table, and tree were generated from Qiime2 using DADA2 and Silva database classifier extracted lenght (515-806). Note: Mitochondria and Chloroplast have been filterd and removed from OTU table.

###STEP1: Load all necessary packages for analysis
More information about Phyloseq can be found at the following link: [Phyloseq](https://joey711.github.io/phyloseq/)
If you get error in this step, you probably need to install any packages which causes error.

```{r warning=FALSE, message=FALSE}
library(ape)
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(data.table)
library(tidyr)
library(tidyverse)
```

###STEP2: Transition data from Qiime2 to Phyloseq
Note: otu table and taxonomy table have been fixed right after Qiime2. Nat's Qiime2 script already include this step.
However, you can simply fix by changing "#Feature ID" to "OTU ID" ot "OTU.ID" and the following commnand should work fine.

####STEP2.1: Import otu table from Qiime2

```{r}
otu = read.table(file="JornadaBacQ2FWLEsilva515806.V1.otu_table.fix.txt", header=T, sep='\t')
```

```{r}
head(otu)
```

Please note dimension of otu table. For this project, there are 37741 rows(OTU.ID) which will need to be matched to taxonomy table before starting Phyloseq analysis.
```{r}
dim(otu)
```

####STEP2.2: Import taxonomy table from Qiime2

```{r}
tax <- read.table(file="taxonomy.fix.tsv", sep='\t', header=TRUE)
head(tax)
```

Taxonomy table contains 38130 rows(OTU.ID) which is more than otu table. (Mitochondria and Chloroplast were removed in otu table which resulted in less number of OTU.ID in otu table.)
```{r}
dim(tax)
```

####STEP2.3: Match OTU.ID between otu and taxonomy table
Keep only OTU.ID in taxonomy table  that were found in otu table.
```{r}
tax_filtered <- tax[tax$OTU.ID %in% otu$OTU.ID,]
head(tax_filtered)
```

Check dimension of tax_filterd table: the number of OTU.ID should be the same as OTU table (in this case: 37741 OTU.ID)
```{r}
dim(tax_filtered)
```

Number of rows for "tax_filtered" and "otu" should be the same.
```{r}
dim(otu)
```

####STEP2.4: Select only OTU.ID column and taxonomy for taxonomy table
Taxonomy table from Qiime2 also contains the third column which is "Confidence". We will remove this column before loading data to Phyloseq.
```{r}
tax_filtered = tax_filtered[,c(1,2)]
```

After selection, taxonomy column will be separated into 7 levels as "Kingdom","Phylum","Class","Order", "Family", "Genus","Species"
```{r}
tax_filtered = separate(tax_filtered, Taxon, c("Kingdom","Phylum","Class","Order", "Family", "Genus","Species"), sep= ";", remove=TRUE)
```

At the end of this step, taxonomy table will contain OTU.ID column + 7 levels taxonomy columns (total of 8 columns). 
```{r}
dim(tax_filtered)
```

```{r}
head(tax_filtered)
```

Save "filtered" taxonomy table for Phyloseq and future usage.
```{r}
write.csv(tax_filtered, file="taxonomy_phyloseq_fix.csv")
```

###STEP3: Import otu table for analysis using Phyloseq 

```{r warning=FALSE}
otus <- read.table("JornadaBacQ2FWLEsilva515806.V1.otu_table.fix.txt",
                   header=T,sep="\t",row.names = 1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
```

###STEP4: Import taxonomy table for analysis using Phyloseq
This taxonomy table was created from STEP2.
```{r warning=FALSE}
taxmat <- read.csv("taxonomy_phyloseq_fix.csv", 
                   sep=",",row.names=1)
row.names(taxmat) = taxmat$OTU.ID
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
```

###STEP5: Import tree file for analysis using Phyloseq

```{r warning=FALSE}
treefile = "tree.nwk"
tree = read.tree(treefile)
```

###STEP6: Import mapping file for analysis using Phyloseq

1.Check mapping file before import to R, R will automatically change sample name that starts with number or contain “-” in sample name. If you get error in this step, you should check sample name first. 

2.First column of first row should not start with #, R will not read the first row that starts with #

3. You can choose which samples to include in analysis by indicating specific group in the column

Note: Fred mapping file has been fixed to match current Sample ID from Qiime2 results (begin with NP instead of N).
```{bash}
sed 's/N/NP/' FredMapDEc9.txt > FredMapDEc9.fix.txt
```

```{r warning=FALSE}
meta = read.table("FredMapDEc9.fix.txt",
                  header=TRUE,row.names=1,
                  sep="\t",stringsAsFactors=FALSE)
```

Check if your metadata file has been import successfully and correctly, the output will show a table of your metadata file (mapping file). *If you do not have header, you might start your first row with # (remove # and reload your mapping file).

```{r}
head(meta)
```

Construct sample_data-class using imported metadata
```{r warning=FALSE}
sampleData <- sample_data(meta)
```

###STEP7: Construct Phyloseq object
To construct phyloseq object, otu table, taxonomy table, and sampleData are required. Phylogenetic tree can be included, but it is not necessary for constructing phyloseq object.
Construct Phyloseq object called "Physeq"

```{r warning=FALSE}
physeq = phyloseq(OTU,TAX,sampleData,tree)
```

###STEP8: Check phyloseq object
This should indicate that your physeq is a "phyloseq-class experiment-level object"

```{r}
physeq
```

###STEP9: Remove ASVs
Remove any ASVs that present only 10 times.

```{r}
physeq.prune = prune_taxa(taxa_sums(physeq) > 5, physeq)
```

```{r}
physeq.prune
```

###STEP10: Plot read counts to check dataset
Check read counts: any samples that have very low reads should be removed.
[Ref](http://evomics.org/wp-content/uploads/2016/01/phyloseq-Lab-01-Answers.html)

```{r}
readcount = data.table(as(sample_data(physeq.prune), "data.frame"),
                 TotalReads = sample_sums(physeq.prune), 
                 keep.rownames = TRUE)
setnames(readcount, "rn", "SampleID")
#For plotting, use command below.
#SeqDepth = ggplot(readcount, aes(TotalReads)) + geom_histogram() + ggtitle("Sequencing Depth")
```

TotalReads of all the samples can be in this table (select only SampleID and TotalReads columns).
In order to check samples with low number of reads, "order()" can be used to sort "TotalReads" column.
In this dataset, N55.Rhizo has very low number of reads, so will will filter this sample out using the next minimum number of reads.
```{r}
readcount = readcount[order(readcount$TotalReads), c("SampleID", "TotalReads")]
```

```{r}
head(readcount)
```

###STEP11: Rarefy OTUs to a minimum number of reads
Rarefy OTUs (remove any samples that has very low number of reads)
If this step work fine, you have successfully imported data to R and completely generate phyloseq object as "physeq.prune.rarefy".
```{r warning=FALSE}
set.seed(711)
physeq.prune.rarefy = rarefy_even_depth(physeq.prune, sample.size = 34605, replace = FALSE, trimOTUs = TRUE)
physeq.prune.rarefy
```

###STEP12.1: Extract OTUs table from Phyloseq

```{r}
Filtered_OTUs_table = otu_table(physeq.prune.rarefy)
```

Save "filtered" otu table from Phyloseq for Vegan NMDS
```{r}
write.csv(Filtered_OTUs_table, file="Filtered_ASVs_table.csv")
```

###STEP12.2: Extract Taxonomy table from Phyloseq

```{r}
Filtered_TAX_table = tax_table(physeq.prune.rarefy)
```

Save "filtered" TAX table from Phyloseq for Vegan NMDS
```{r}
write.csv(Filtered_TAX_table, file="Filtered_TAX_table.csv")
```

####STEP13: Subset Kingdoms

Get actual name of Kingdom
```{r}
Kingdoms = as.character(get_taxa_unique(physeq.prune.rarefy, "Kingdom"))
Kingdoms = Kingdoms[complete.cases(Kingdoms)]
```

###STEP13.1: Subset Kingdom Archaea
```{r}
physeq.prune.rarefy.archaea = subset_taxa(physeq.prune.rarefy, Kingdom == "D_0__Archaea")
physeq.prune.rarefy.archaea
```

### STEP13.2: Plot Alpha Diversity Archaea using Plot_Richness command

```{r}
plot_richness(physeq.prune.rarefy.archaea)
```

###Alpha diversity measure: Richness 
```{r message=FALSE}
plot_richness(physeq.prune.rarefy.archaea, x="Site", color=("Site"), measures=c( "Observed")) + geom_boxplot() + ggtitle("Alpha Diversity (Richness) by Vegetation Zone")
```

###Alpha diversity measure: Shannon 
```{r message=FALSE}
plot_richness(physeq.prune.rarefy.archaea, x="Site", color=("Site"), measures=c( "Shannon")) + geom_boxplot() + ggtitle("Alpha Diversity (Shannon) by Vegetation Zone")
```

###Alpha diversity measure: Chao1 

```{r}
plot_richness(physeq.prune.rarefy.archaea, x="Site", color=("Site"), measures=c( "Chao1")) + geom_boxplot() + ggtitle("Alpha Diversity (Chao1) by Vegetation Zone")
```

### Reorder Alpha Diversity Chao 1 X-axis and legend 

Use "scale_x_discrete"" to reorder x-axis and "scale_color_discrete"" to reorder legend

```{r}

plot_richness(physeq.prune.rarefy.archaea, x="Site", color=("Site"), measures=c( "Chao1")) + geom_boxplot() + ggtitle("Alpha Diversity (Chao1) by Vegetation Zone") + scale_x_discrete(limits=c("Mesquite","Grassland", "Creosote", "Tarbush", "Playa")) + scale_color_discrete(breaks=c("Mesquite","Grassland", "Creosote", "Tarbush", "Playa"))

```

### ANOVA and Tukey
```{r}
##Anova
alpha.diversity <- estimate_richness(physeq.prune.rarefy.archaea, measures = c("Chao1"))
data.anova <- cbind(sample_data(physeq.prune.rarefy.archaea), alpha.diversity)
physeq.prune.rarefy.archaea.ps.anova.chao1 <- aov(Chao1 ~ Site, data.anova)
summary(physeq.prune.rarefy.archaea.ps.anova.chao1)

```

```{r}
TukeyHSD(physeq.prune.rarefy.archaea.ps.anova.chao1)
```
###STEP13.3:Taxonomy Abundance Plot 
```{r}
psTopNOTUs.archaea = names(sort(taxa_sums(physeq.prune.rarefy.archaea), TRUE)[1:100])
```

```{r}
pstop.prune.archaea = prune_taxa(psTopNOTUs.archaea, physeq.prune.rarefy.archaea)
```

```{r}
plot_bar(pstop.prune.archaea)
```

```{r}
plot_bar(pstop.prune.archaea, x = "Site ", y = "Abundance", fill ="Phylum")
```

```{r}
plot_bar(physeq.prune.rarefy.archaea, x = "Site", y = "Abundance", fill ="Genus") + geom_bar(aes(color=Genus, fill=Genus), stat="identity", position="stack")
```

```{r}
pstop.prune.merge.Site.archaea <- merge_samples(physeq.prune.rarefy.archaea, "Site")
sample_data(pstop.prune.merge.Site.archaea)$Site <- factor(sample_names(pstop.prune.merge.Site.archaea))
pstop.prune.transform.Site.archaea = transform_sample_counts(pstop.prune.merge.Site.archaea, 
                                                      function(x) 100 * x/sum(x))
```

```{r}
plot_bar(pstop.prune.transform.Site.archaea, x = "Sample", y = "Abundance", fill ="Genus") + 
  geom_bar(aes(color=Genus, fill=Genus), stat="identity", position="stack")
```

```{r}
plot_bar(pstop.prune.transform.Site.archaea, x = "Site", y = "Abundance", fill ="Phylum") + 
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
  ggtitle("Archaea Community by Vegetation Zone") + theme_bw()
```

## STEP13.4:Beta diversity Archaea NMDS

```{r}
physeq.prune.rarefy.ps.ord.archaea <- ordinate(physeq.prune.rarefy.archaea, "NMDS", "unifrac")

#plot_ordination(physeq.prune.rarefy.archaea, physeq.prune.rarefy.ps.ord.archaea)

#plot_ordination(physeq.prune.rarefy.archaea, physeq.prune.rarefy.ps.ord.archaea, type = "samples", color = "Site")

#plot_ordination(physeq.prune.rarefy.archaea, physeq.prune.rarefy.ps.ord.archaea, type = "samples", 
#                color = "Site", shape = "Site") + 
#  theme_bw()
  
plot_ordination(physeq.prune.rarefy, physeq.prune.rarefy.ps.ord.archaea, type = "samples", 
                color = "Site", shape = "Site")  + 
  theme_bw() + ggtitle("Archaeal Beta Diversity (NMDS) by Site") #+ 
  #stat_ellipse(geom = "polygon", alpha = 1/8, aes(fill = Site))
  

```

```{r}
ps.dist = phyloseq::distance(physeq.prune.rarefy.archaea, "unifrac")
adonis(ps.dist ~ Site, as(sample_data(physeq.prune.rarefy.archaea),"data.frame"))
```

```{r}
physeq.prune.rarefy.archaea.ps.ord.nmds <- ordinate(physeq.prune.rarefy.archaea, "NMDS", "unifrac")
## Run 0 stress 0.08337151 
## Run 1 stress 0.08560694 
## Run 2 stress 0.09431811 
## Run 3 stress 0.09232079 
## Run 4 stress 0.4166941 
## Run 5 stress 0.08521983 
## Run 6 stress 0.08223814 
## ... New best solution
## ... Procrustes: rmse 0.01064178  max resid 0.09654523 
## Run 7 stress 0.08564263 
## Run 8 stress 0.09393183 
## Run 9 stress 0.08541595 
## Run 10 stress 0.08627038 
## Run 11 stress 0.08898824 
## Run 12 stress 0.09182466 
## Run 13 stress 0.09295713 
## Run 14 stress 0.08746598 
## Run 15 stress 0.09892388 
## Run 16 stress 0.09286881 
## Run 17 stress 0.08653866 
## Run 18 stress 0.09612134 
## Run 19 stress 0.0847709 
## Run 20 stress 0.08532441 
## *** No convergence -- monoMDS stopping criteria:
##     20: stress ratio > sratmax
plot_ordination(physeq.prune.rarefy.archaea, physeq.prune.rarefy.archaea.ps.ord.nmds, type = "samples", 
                color = "Site", shape = "Site")  + 
  theme_bw() + ggtitle("Archaeal Beta Diversity (NMDS) by Site") + 
  stat_ellipse(geom = "polygon", alpha = 1/8, aes(fill = Site))
```

```{r}
ps.dist = phyloseq::distance(physeq.prune.rarefy.archaea, "unifrac")
Archaea.Beta<-adonis(ps.dist~Site, as(sample_data(physeq.prune.rarefy.archaea),"data.frame"))
Archaea.Beta
```

####STEP14: Subset Phylums

Get actual name of Phylum
```{r}
Phyla = as.character(get_taxa_unique(physeq.prune.rarefy, "Phylum"))
Phyla = Phyla[complete.cases(Phyla)]
```

###STEP14.1:Subset Phylum Thaumarchaeota
```{r}
physeq.prune.rarefy.thaum = subset_taxa(physeq.prune.rarefy, Phylum == "D_1__Thaumarchaeota")
physeq.prune.rarefy.thaum
```

###STEP14.2: Plot Alpha Diversity Thaumarchaeota using Plot_Richness command

```{r}
plot_richness(physeq.prune.rarefy.thaum)
```

### Richness 
```{r message=FALSE}
plot_richness(physeq.prune.rarefy.thaum, x="Site", color=("Site"), measures=c( "Observed")) + geom_boxplot() + ggtitle("Thaumarchaeota Alpha Diversity (Richness) by Vegetation Zone")
```

###Shannon 
```{r message=FALSE}
plot_richness(physeq.prune.rarefy.thaum, x="Site", color=("Site"), measures=c( "Shannon")) + geom_boxplot() + ggtitle("Thaumarchaeota Alpha Diversity (Shannon) by Vegetation Zone")
```

###Alpha diversity measure: Chao1 

```{r}
plot_richness(physeq.prune.rarefy.thaum, x="Site", color=("Site"), measures=c( "Chao1")) + geom_boxplot() + ggtitle("Thaumarchaeota Alpha Diversity (Chao1) by Vegetation Zone")
```

### ANOVA and Tukey
```{r}
##Anova
alpha.diversity <- estimate_richness(physeq.prune.rarefy.thaum, measures = c("Chao1"))
data.anova <- cbind(sample_data(physeq.prune.rarefy.thaum), alpha.diversity)
physeq.prune.rarefy.thaum.ps.anova.chao1 <- aov(Chao1 ~ Site, data.anova)
summary(physeq.prune.rarefy.thaum.ps.anova.chao1)

```

```{r}
TukeyHSD(physeq.prune.rarefy.thaum.ps.anova.chao1)
```

###STEP14.3: Taxonomy Abundance Plots Thaumarcheota
```{r}
psTopNOTUs.thaum = names(sort(taxa_sums(physeq.prune.rarefy.thaum), TRUE)[1:100])
```

```{r}
pstop.prune.thaum = prune_taxa(psTopNOTUs.thaum, physeq.prune.rarefy.thaum)
```

```{r}
plot_bar(pstop.prune.thaum)
```

```{r}
plot_bar(pstop.prune.thaum, x = "Site ", y = "Abundance", fill ="Order")
```

```{r}
plot_bar(pstop.prune.thaum, x = "Site", y = "Abundance", fill ="Order") + geom_bar(aes(color=Order, fill=Order), stat="identity", position="stack")
```

###STEP15: Subset Kingdom Bacteria
```{r}
physeq.prune.rarefy.bacteria = subset_taxa(physeq.prune.rarefy, Kingdom == "D_0__Bacteria")
physeq.prune.rarefy.bacteria
```

###STEP15.1: Plot Alpha Diversity Bacteria using Plot_Richness command

```{r}
plot_richness(physeq.prune.rarefy.bacteria)
```

```{r message=FALSE}
plot_richness(physeq.prune.rarefy.bacteria, x="Site", color=("Site"), measures=c( "Observed")) + geom_boxplot() + ggtitle("Bacteria Alpha Diversity (Richness) by Vegetation Zone")
```

###Shannon 
```{r message=FALSE}
plot_richness(physeq.prune.rarefy.bacteria, x="Site", color=("Site"), measures=c( "Shannon")) + geom_boxplot() + ggtitle("Bacteria Alpha Diversity (Shannon) by Vegetation Zone")
```

###Alpha diversity measure: Chao1 

```{r}
plot_richness(physeq.prune.rarefy.bacteria, x="Site", color=("Site"), measures=c( "Chao1")) + geom_boxplot() + ggtitle("Bacteria Alpha Diversity (Chao1) by Vegetation Zone")
```

### Reorder Alpha Diversity X-axis and legend 

Use "scale_x_discrete"" to reorder x-axis and "scale_color_discrete"" to reorder legend

```{r}

plot_richness(physeq.prune.rarefy.bacteria, x="Site", color=("Site"), measures=c( "Chao1")) + geom_boxplot() + ggtitle("Bacteria Alpha Diversity (Chao1) by Vegetation Zone") + scale_x_discrete(limits=c("Mesquite","Grassland", "Creosote", "Tarbush", "Playa")) + scale_color_discrete(breaks=c("Mesquite","Grassland", "Creosote", "Tarbush", "Playa"))

```

### ANOVA and Tukey
```{r}
alpha.diversity <- estimate_richness(physeq.prune.rarefy.bacteria, measures = c("Chao1"))
data.anova <- cbind(sample_data(physeq.prune.rarefy.bacteria), alpha.diversity)
physeq.prune.rarefy.bacteria.ps.anova.chao1 <- aov(Chao1 ~ Site, data.anova)
summary(physeq.prune.rarefy.bacteria.ps.anova.chao1)

```

```{r}
TukeyHSD(physeq.prune.rarefy.archaea.ps.anova.chao1)
```

###STEP15.2: Taxonomy Abundance Plots Bacteria 
```{r}
psTopNOTUs.bacteria = names(sort(taxa_sums(physeq.prune.rarefy.bacteria), TRUE)[1:100])
```

```{r}
pstop.prune.bacteria = prune_taxa(psTopNOTUs.bacteria, physeq.prune.rarefy.bacteria)
```

```{r}
plot_bar(pstop.prune.bacteria)
```

```{r}
plot_bar(pstop.prune.bacteria, x = "Site ", y = "Abundance", fill ="Phylum")
```

```{r}
plot_bar(pstop.prune.bacteria, x = "Site", y = "Abundance", fill ="Phylum") + geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")
```

```{r}
pstop.prune.merge.Site.bacteria <- merge_samples(pstop.prune.bacteria, "Site")
sample_data(pstop.prune.merge.Site.bacteria)$Site <- factor(sample_names(pstop.prune.merge.Site.bacteria))
pstop.prune.transform.Site.bacteria = transform_sample_counts(pstop.prune.merge.Site.bacteria, 
                                                      function(x) 100 * x/sum(x))
```

```{r}
plot_bar(pstop.prune.transform.Site.bacteria, x = "Sample", y = "Abundance", fill ="Phylum") + 
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")
```

```{r}
plot_bar(pstop.prune.transform.Site.bacteria, x = "Site", y = "Abundance", fill ="Phylum") + 
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
  ggtitle("Bacteria Community by Vegetation Zone") + theme_bw()
```

## Beta diversity NMDS

```{r}
physeq.prune.rarefy.ps.ord.bacteria <- ordinate(physeq.prune.rarefy.bacteria, "NMDS", "unifrac")

plot_ordination(physeq.prune.rarefy.bacteria, physeq.prune.rarefy.ps.ord.bacteria)

plot_ordination(physeq.prune.rarefy.bacteria, physeq.prune.rarefy.ps.ord.bacteria, type = "samples", color = "Site")

plot_ordination(physeq.prune.rarefy.bacteria, physeq.prune.rarefy.ps.ord.bacteria, type = "samples", 
                color = "Site", shape = "Site") + 
  theme_bw()
  
plot_ordination(physeq.prune.rarefy.bacteria, physeq.prune.rarefy.ps.ord.bacteria, type = "samples", 
                color = "Site", shape = "Site")  + 
  theme_bw() + ggtitle("Bacterial Beta Diversity (NMDS) by Site") + 
  stat_ellipse(geom = "polygon", alpha = 1/8, aes(fill = Site))
  
```

```{r}
ps.dist = phyloseq::distance(physeq.prune.rarefy.bacteria, "unifrac")
adonis(ps.dist ~ Site, as(sample_data(physeq.prune.rarefy.bacteria),"data.frame"))
```

####STEP16: Subset Phylums in Bacteria

Get actual name of Phylum
```{r}
Phyla = as.character(get_taxa_unique(physeq.prune.rarefy, "Phylum"))
Phyla = Phyla[complete.cases(Phyla)]
```

###Subset Phylum Cyanobacteria
```{r}
physeq.prune.rarefy.cyano = subset_taxa(physeq.prune.rarefy, Phylum == "D_1__Cyanobacteria")
physeq.prune.rarefy.cyano
```

###STEP16.1: Plot Alpha Diversity Archaea using Plot_Richness command

```{r}
plot_richness(physeq.prune.rarefy.cyano)
```

### Richness 
```{r message=FALSE}
plot_richness(physeq.prune.rarefy.cyano, x="Site", color=("Site"), measures=c( "Observed")) + geom_boxplot() + ggtitle("Cyano Alpha Diversity (Richness) by Vegetation Zone")
```
###Shannon 
```{r message=FALSE}
plot_richness(physeq.prune.rarefy.cyano, x="Site", color=("Site"), measures=c( "Shannon")) + geom_boxplot() + ggtitle("Cyano Alpha Diversity (Shannon) by Vegetation Zone")
```

###Alpha diversity measure: Chao1 

```{r}
plot_richness(physeq.prune.rarefy.cyano, x="Site", color=("Site"), measures=c( "Chao1")) + geom_boxplot() + ggtitle("Cyano Alpha Diversity (Chao1) by Vegetation Zone")
```
### Reorder Alpha Diversity X-axis and legend 

Use "scale_x_discrete"" to reorder x-axis and "scale_color_discrete"" to reorder legend

```{r}

plot_richness(physeq.prune.rarefy.cyano, x="Site", color=("Site"), measures=c( "Chao1")) + geom_boxplot() + ggtitle("Cyanobacteria Alpha Diversity (Chao1) by Vegetation Zone") + scale_x_discrete(limits=c("Mesquite","Grassland", "Creosote", "Tarbush", "Playa")) + scale_color_discrete(breaks=c("Mesquite","Grassland", "Creosote", "Tarbush", "Playa"))

```
### ANOVA and Tukey
```{r}
alpha.diversity <- estimate_richness(physeq.prune.rarefy.cyano, measures = c("Chao1"))
data.anova <- cbind(sample_data(physeq.prune.rarefy.cyano), alpha.diversity)
physeq.prune.rarefy.cyano.ps.anova.chao1 <- aov(Chao1 ~ Site, data.anova)
summary(physeq.prune.rarefy.cyano.ps.anova.chao1)

```

```{r}
TukeyHSD(physeq.prune.rarefy.cyano.ps.anova.chao1)
```

###Abundance Plot 
```{r}
psTopNOTUs.cyano = names(sort(taxa_sums(physeq.prune.rarefy.cyano), TRUE)[1:100])
```

```{r}
pstop.prune.cyano = prune_taxa(psTopNOTUs.cyano, physeq.prune.rarefy.cyano)
```

```{r}
plot_bar(pstop.prune.cyano)
```

```{r}
plot_bar(pstop.prune.cyano, x = "Site ", y = "Abundance", fill ="Order")
```

```{r}
plot_bar(physeq.prune.rarefy.cyano, x = "Site", y = "Abundance", fill ="Order") + geom_bar(aes(color=Order, fill=Order), stat="identity", position="stack")
```

```{r}
pstop.prune.merge.Site.cyano <- merge_samples(physeq.prune.rarefy.cyano, "Site")
sample_data(physeq.prune.rarefy.cyano)$Site <- factor(sample_names(physeq.prune.rarefy.cyano))
pstop.prune.transform.Site.cyano = transform_sample_counts(physeq.prune.rarefy.cyano, 
                                                      function(x) 100 * x/sum(x))
```

```{r}
plot_bar(pstop.prune.transform.Site.cyano, x = "Sample", y = "Abundance", fill ="Genus") + 
  geom_bar(aes(color=Genus, fill=Genus), stat="identity", position="stack")
```

```{r}
plot_bar(pstop.prune.transform.Site.cyano, x = "Site", y = "Abundance", fill ="Order") + 
  geom_bar(aes(color=Order, fill=Order), stat="identity", position="stack") +
  ggtitle("Cyano Community by Vegetation Zone") + theme_bw()
```